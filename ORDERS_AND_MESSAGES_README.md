# Функционал заказов и сообщений в админке

## Обзор

Добавлен простой функционал управления заказами и сообщениями от клиентов в админ-панели. 

## Что было реализовано

### 1. Заказы с сайта
- Список всех заказов с возможностью фильтрации по статусам
- Просмотр детальной информации о заказе
- Изменение статуса заказа (Новый, В обработке, Завершен, Отменен)
- Удаление заказов
- Полностью на русском языке

### 2. Сообщения от клиентов
- **Модальное окно для отправки вопросов** прямо из конфигуратора (кнопка "Задать вопрос")
- Список всех сообщений с возможностью фильтрации по статусам
- Просмотр полного текста сообщения
- Ответ на сообщения клиентов
- Изменение статуса сообщения (Новое, Отвечено, Закрыто)
- Удаление сообщений

## Установка и настройка

### Шаг 1: Применить миграцию базы данных

Выполните миграцию для создания таблицы сообщений:

```bash
# Из директории exce1sior-configurator
supabase db push
```

Или примените миграцию вручную:

```sql
-- Файл: supabase/migrations/014_create_chat_messages_table.sql
```

### Шаг 2: Проверить работу

1. Войдите в админ-панель: `/login`
2. Перейдите в раздел "Manufacturer Dashboard"
3. Вы увидите новые вкладки:
   - **Заказы** - для управления заказами
   - **Сообщения** - для работы с вопросами клиентов

## Структура файлов

### Новые файлы:

1. **supabase/migrations/014_create_chat_messages_table.sql**
   - Миграция для создания таблицы chat_messages
   - Создает индексы и RLS политики

2. **src/services/chatService.ts**
   - Сервис для работы с сообщениями
   - Функции: создание, получение, обновление, удаление, ответ на сообщения

3. **src/components/admin/MessagesList.tsx**
   - Компонент списка сообщений для админки
   - Фильтрация, просмотр, ответ, управление статусами

4. **src/components/ChatModal.tsx**
   - Модальное окно для отправки вопросов клиентами
   - Валидация полей, отправка сообщений

5. **src/components/ChatModal.css**
   - Стили для модального окна чата
   - Адаптивный дизайн для мобильных устройств

### Обновленные файлы:

1. **src/pages/ManufacturerAdminPage.tsx**
   - Добавлены вкладки "Заказы" и "Сообщения"
   - Переведены на русский язык

2. **src/components/admin/OrdersList.tsx**
   - Переведен интерфейс на русский язык
   - Улучшен пользовательский опыт

3. **src/types/database.ts**
   - Добавлен тип ChatMessage

4. **src/App.tsx**
   - Добавлено модальное окно для отправки вопросов
   - Кнопка "Задать вопрос" теперь функциональна
   - Переведены кнопки на русский язык

## API сервисов

### Chat Service (chatService.ts)

```typescript
// Создать сообщение
createChatMessage({ formData: ChatMessageFormData })

// Получить все сообщения
getChatMessages(filters?: { status?: string, limit?: number })

// Получить сообщение по ID
getChatMessageById(messageId: string)

// Обновить статус
updateMessageStatus(messageId: string, status: 'new' | 'replied' | 'closed')

// Ответить на сообщение
replyToChatMessage(messageId: string, response: string, adminId: string)

// Удалить сообщение
deleteChatMessage(messageId: string)
```

### Order Service (orderService.ts)

```typescript
// Создать заказ
createOrder(params: CreateOrderParams)

// Получить все заказы
getOrders(filters?: { status?: string, limit?: number })

// Получить заказ по ID
getOrderById(orderId: string)

// Обновить статус
updateOrderStatus(orderId: string, status: OrderStatus)

// Удалить заказ
deleteOrder(orderId: string)
```

## База данных

### Таблица chat_messages

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | ID сообщения |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |
| customer_name | TEXT | Имя клиента |
| customer_email | TEXT | Email клиента (опционально) |
| customer_phone | TEXT | Телефон клиента (опционально) |
| message | TEXT | Текст сообщения |
| admin_response | TEXT | Ответ администратора |
| admin_response_at | TIMESTAMP | Время ответа |
| admin_id | UUID | ID администратора |
| status | TEXT | Статус: new, replied, closed |

### Таблица orders (уже существует)

Используется существующая таблица orders с переведенным интерфейсом.

## Безопасность

### RLS (Row Level Security)

- **Публичные пользователи** (anon) могут:
  - Создавать заказы
  - Создавать сообщения

- **Администраторы** (authenticated + is_admin()) могут:
  - Читать все заказы и сообщения
  - Обновлять статусы
  - Отвечать на сообщения
  - Удалять записи

## Использование для клиентов

### Отправка вопроса из конфигуратора

1. Пользователь нажимает кнопку "Задать вопрос" в боковой панели
2. Открывается модальное окно с формой
3. Заполняются обязательные поля:
   - Имя
   - Email или телефон (хотя бы один)
   - Текст вопроса
4. После отправки показывается сообщение об успехе
5. Администратор получает вопрос во вкладке "Сообщения"

## Будущие улучшения

Возможные доработки (не реализовано):

1. ✅ ~~Интеграция формы отправки сообщений на фронтенде~~ (РЕАЛИЗОВАНО)
2. Email уведомления при получении ответа
3. История изменений статусов
4. Экспорт данных в CSV/Excel
5. Статистика и аналитика
6. Поиск по заказам и сообщениям
7. Прикрепление файлов к сообщениям
8. Автоответы для часто задаваемых вопросов

## Использование

### Просмотр заказов

1. Откройте вкладку "Заказы"
2. Выберите фильтр статуса (Все, Новый, В обработке, Завершен, Отменен)
3. Нажмите на заказ для просмотра деталей
4. Измените статус или удалите заказ при необходимости

### Работа с сообщениями

1. Откройте вкладку "Сообщения"
2. Выберите фильтр статуса (Все, Новое, Отвечено, Закрыто)
3. Нажмите на сообщение для просмотра
4. Введите ответ в текстовое поле
5. Нажмите "Отправить ответ"
6. Статус автоматически изменится на "Отвечено"

## Поддержка

При возникновении проблем проверьте:

1. Применена ли миграция базы данных
2. Есть ли права администратора у пользователя
3. Настроены ли RLS политики в Supabase
4. Работает ли подключение к базе данных

## Лицензия

Часть проекта Exce1sior Configurator

